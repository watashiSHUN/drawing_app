<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Data Viewer</title>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <h1>Data Viewer</h1>
        <div id="input_container">
            <div id="classification"></div>
        </div>
        <div id="chart_container"></div><!--refactor chart to be its own html page -->
        <div id="container"></div>
        <!-- data -->
        <script src="../data/dataset/js/features.js"></script>

        <!-- common code -->
        <script src="../common/constants_module.js"></script>
        <script src="../common/utils_module.js"></script>
        <script src="../common/draw_module.js"></script>
        <script src="../common/features_module.js"></script>

        <!-- drawing sketchpad(same sketchpad as the one we used in "data_collector.html") -->
        <script src="sketch_pad.js"></script>
        
        <!-- display chart -->
        <script src="display_table.js"></script>
        <script src="../github/chart.js"></script>
        <script src="../github/graphics.js"></script>
        <script src="../github/math.js"></script>
        
        <!-- if we were to use google chart library:
        <script src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="display_chart.js"></script> 
        -->

        <script>
            const {metadatas, feature_names} = features;
            // NOTE: variable `metadata` is available when we load metadata.js
            const student_drawings = utils.groupByKey(metadatas, "student_id");
            
            let row_count = 0;
            for (let student_id in student_drawings){
                const drawing_metadatas = student_drawings[student_id];
                const student_name = drawing_metadatas[0].student_name;
                createRow(/*div=*/container, student_name, drawing_metadatas);
                row_count++;
                if (row_count >= 50){
                    break;
                }
            }
            const style = {
                    car: {color: "red", text: "ðŸš—"},
                    fish: {color: "blue", text: "ðŸŸ"},
                    house: {color: "green", text: "ðŸ "},
                    tree: {color: "purple", text: "ðŸŒ³"},
                    bicycle: {color: "orange", text: "ðŸš´"},
                    guitar: {color: "brown", text: "ðŸŽ¸"},
                    pencil: {color: "black", text: "ðŸ“"},
                    clock: {color: "gray", text: "â°"}
                };

            const options = {
                size: constants.CANVAS_SIZE*3,
                axesLabels: feature_names,
                styles: style,
                transparency: 0.6,
                icon: "image",
                // TODO(shunxian): when we click on the item, 
                // it should highlight and display the drawing
            };

            graphics.generateImages(style);

            const chart = new Chart(chart_container, metadatas, options);

            const sketch_pad = new SketchPad(input_container, constants.CANVAS_SIZE, 
            /*on_redraw=*/(paths)=>{
                const extraction = features_function.active.map(f=>f.function(paths));
                const classification_text = classify(extraction);
                classification.innerHTML = "Is it a " + classification_text + "?";
                chart.drawPoint(extraction);
            });

            function classify(extraction){
                // Get all the features data
                const metadata_feature_points = metadatas.map((metadata) => metadata.features);
                const k = 7;
                const indexes = utils.getKNearestPoint(extraction, metadata_feature_points, k);
                // return the most frequently occuring drawing.
                const occurences = {"":0};
                let return_drawing = "";
                for (let i = 0; i < indexes.length; i++){
                    const index = indexes[i];
                    const drawing = metadatas[index].drawing;
                    if (occurences[drawing] === undefined){
                        occurences[drawing] = 1;
                    } else {
                        occurences[drawing]++;
                    }
                    if (occurences[drawing] > occurences[return_drawing]){
                        return_drawing = drawing;
                    }
                }

                console.log(occurences);
                return return_drawing;
            }
        </script>
    </body>